name: Project Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      name:
        description: 'First name'
        required: true
        default: 'Edem'
      second_name:
        description: 'Second name'
        required: true
        default: 'Manyo'

env:
  # To be reviewed (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: Release

# if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name != github.event.pull_request.base.repo.full_name
jobs:
  build:
    name: Build

    # Github runner this will run on
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true

    # Temporary install of dependencies. TODO: To be reviewed
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install \
          build-essential \
          libx11-dev \
          libxcursor-dev \
          libxi-dev \
          libxinerama-dev \
          libxrandr-dev \
          ninja-build

    # Build with Ninja generator
    - name: Build
      run: cmake -G Ninja -S . -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

    # Execute the tests. TODO: To be reviewed
    # - name: Test
    #   run: ctest ...
  
  check_tidy:
    name: Clang-tidy

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install clang-tidy 20
        run: |
          sudo apt-get update
          sudo apt-get purge --auto-remove llvm python3-lldb-14 llvm-14 -y
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 20
          sudo apt-get install -y clang-tidy-20
      
      - name: Clang-tidy version
        run: |
          clang-tidy-20 --version

      # Run clang tidy
      - name: Run clang-tidy
        run: clang-tidy-20 -format-style=file -header-filter=. -p build src/**/*.cpp

  check_formatting:
    name: Clang-format

    # Github runner this will run on
    runs-on: ubuntu-latest
    env:
      CLANG_HOME: /usr/bin/llvm-20

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Cache clang-format
      uses: actions/cache@v4
      with:
        path: |
          ${{ env.CLANG_HOME }}
        key: ${{ runner.os }}-clang-format-20-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
            ${{ runner.os }}-clang-format-20-

    - name: Install clang-format 20
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format-20
        export CLANG_HOME="/usr/lib/llvm-20"
        echo "CLANG_HOME=$CLANG_HOME" >> $GITHUB_ENV
    
    - name: Clang-format version
      run: |
        clang-format-20 --version

    # Run clang-format src/**/*.h includes/**/*.h
    - name: Run clang-format
      run: |
        clang-format-20 -style=file src/**/*.cpp
    
    - name: Check for unformatted files
      run: |
        git diff --exit-code || (echo "Code is not formatted correctly" && exit 1)
  
  tests_cppcheck:
    name: Cppcheck

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      
      # Run Cppcheck using deep5050: for integration to CI/CD
      - name: Run cppcheck
        uses: deep5050/cppcheck-action@main
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          enable: style,warning,performance
          exclude_check: "unusedFunction"
          inconclusive: true
